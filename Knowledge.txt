
  DOSVAXJ3 技術情報

・日本語キーボード対応
　日本語キーボードの場合、^ [ : が SDL_KEYDOWN の event.key.keysym.scancode で
90h, 91h, 92h として入ってきます。これを sdlkey_map[] (sdl_mapper.cpp) で
SDLK_F13, SDLK_F14, SDLK_F15 に変換し、さらに KEYBOARD_AddKey() (keyboard.cpp)
で 93, 94, 95 というコードに変換します。あとは jp.kl(jp.key) の定義で各文字に
割り振っています。
　Linux の場合、^ や : は大丈夫なのですが @ [ ] のスキャンコードが英語キーボー
ド相当になってしまっており、keyboardlayout=jp の場合に無理矢理スキャンコードを
変更する事で対処しています。

・MS-IME
　MS-IME でキーが入りっぱなしになってしまうのは、本来 IME 側で使用されているは
ずのキーコードの SDL_KEYDOWN が入ってきてしまい、さらに SDL_KEYUP が来ないため
に発生します。
　SDL_KEYDOWN が来た時点で IME が ON 状態ならキャンセルしているのですが、問題
が発生する場合は IME の状態が正しく取得できません。
　Vista 以降で廃止された Imm～ な API を使用しているのが問題と思われます。
　MS-IME でも IME の状態取得も正常で、終了時のハングアップが発生しない環境も
あるようなのですが、原因はわかりません。
　本来は TSF を使用するべきなのでしょうが、とりあえず ATOK 等では大丈夫なので
放置しています。

・日本語関連
　日本語ファイル名を使用可能としています。
　Linux 版の場合、UTF-8 と Shift-JIS の相互変換を行っています。UTF-8 決め打ち
ですのでご注意ください。今時 EUC を使っている環境は流石にないと思いますが。
　変換処理の抜けがあるかもしれませんのでご注意ください。
　内蔵シェルのコマンドライン、DOS の一行入力についても日本語対応(全角文字を
BS できちんと削除可能等)しています。

・ESC シーケンス
　DOSBox で対応している ESC シーケンス以外に、下記に対応しています。
ESC [>5h   カーソル非表示     J-3100 対策
ESC [>5l   カーソル表示       J-3100 対策
ESC [ ; p  キー再割り当て     JEMO 対策
　ESC シーケンスは DOS の CON 出力内部で解釈しているので、int 29h 経由で ESC
シーケンスを出力しているようなプログラムは期待通りの動作をしません。

・J-3100 モード
　J-3100 モードで外字が 100 文字に限定されるのは DOS_GetMemory() で使用する領
域がオーバーしてしまうためです。コンベンショナルメモリに置けばいいのですが、
とりあえず安直な対応としています。
　また、V-Text で XGA, SXGA が使用できないのはビデオカードを ET-4000 相当にす
ると DCGA モードの表示が縦長になってしまうためです。これは将来的には対応した
いと思っています。
　漢字 ROM は \ 半角カナの領域のみフォントデータを返すようにしています。
　バンク切り替えは無視しています。
　漢字フォントデータは基本的には int60h 経由で取得されるはずですので問題はな
いはずです。

                                                                      takapyu
