
  DOSVAXJ3 技術情報

・日本語キーボード対応
　日本語キーボードの場合、^ [ : が SDL_KEYDOWN の event.key.keysym.scancode で
90h, 91h, 92h として入ってきます。これを sdlkey_map[] (sdl_mapper.cpp) で
SDLK_F13, SDLK_F14, SDLK_F15 に変換し、さらに KEYBOARD_AddKey() (keyboard.cpp)
で 93, 94, 95 というコードに変換します。あとは jp.kl(jp.key) の定義で各文字に
割り振っています。
　Linux の場合、^ や : は大丈夫なのですが @ [ ] のスキャンコードが英語キーボー
ド相当になってしまっており、keyboardlayout=jp の場合に無理矢理スキャンコードを
変更する事で対処しています。

・MS-IME
　JP190523 で終了時のハングアップに対応しました。
　JP190527 で MS-IME でキー入力が入りっぱなしになってしまう現象の対策を行いま
した。DirectInput のキーボード入力ハンドラ内で、最初にメッセージループを回して
から SDL のイベント発生処理を行うようにしています。また、KeyUp については IME
の状況を問わず SDL のイベントを発生させています。
　しかしながら 状態取得(ImmGetOpenStatus)と状態変更(ImmSetOpenStatus) が正常に
動かない場合があるのは修正できていません。その場合 $IAS.SYS のファンクションを
使用した FEP の制御が正常動作しません。
　MS-IME 以外の ATOK や Google 日本語入力等の使用を推薦します。

・IME 変換文字列表示位置
　JP190510 以前は int 10h ah=02h のカーソル位置設定毎に SDL_SetIMPosition()
を呼び出していました。が、単にコンソール出力でも一文字表示毎に呼び出される事
になってしまい、dir の表示がなめらかでなかったり、Linux では表示中に止まった
りしてしまう等の不具合がおきておりました。
　対策として、タイマで 0040:0050 の値が変更になっており、かつ前回の変更から
100ms 以上経過している場合のみ SDL_SetIMPosition() を呼び出すよう変更してい
ます。

・日本語関連
　日本語ファイル名を使用可能としています。
　Linux 版の場合、UTF-8 と Shift-JIS の相互変換を行っています。UTF-8 決め打ち
ですのでご注意ください。今時 EUC を使っている環境は流石にないと思いますが。
　ファイル名の変換処理の抜けがあるかもしれませんのでご注意ください。
　内蔵シェルのコマンドライン、DOS の一行入力についても日本語対応(全角文字を
BS できちんと削除可能等)しています。

・ESC シーケンス
　DOSBox で対応している ESC シーケンス以外に、下記に対応しています。
ESC [>5h   カーソル非表示     J-3100 対策
ESC [>5l   カーソル表示       J-3100 対策
ESC [ ; p  キー再割り当て     JEMO 対策
　ESC シーケンスは DOS の CON 出力内部で解釈しているので、int 29h 経由で ESC
シーケンスを出力しているようなプログラムは期待通りの動作をしません。

・コンソール出力
　DOS の CON 出力は int 29h を呼び出し、さらに int 29h 内部から int 10h
ah=0eh を呼び出しています。これにより Vz のコンソール取り込みと他のディスプレ
イドライバの使用が可能となります。

・Vz の常駐
　int 21h が Vz に乗っ取られていた場合、内蔵シェルのコマンドラインは使用せず
に DOS ファンクションの ah=0ah 一行入力 を呼び出しています。

・キー入力待ち
　int 28h が常駐プログラムで乗っ取られている場合、int 16h ah=00h, ah=01h で
キー入力待ちとなっている際に int 28h を呼び出します。

・J-3100 モード
　J-3100 モードで外字が 100 文字に限定されるのは DOS_GetMemory() で使用する領
域がオーバーしてしまうためです。コンベンショナルメモリに置けばいいのですが、
とりあえず安直な対応としています。
　漢字 ROM は \ 半角カナの領域のみフォントデータを返すようにしています。
　バンク切り替えは無視しています。
　漢字フォントデータは基本的には int60h 経由で取得されるはずですので問題はな
いはずです。

                                                                      takapyu
